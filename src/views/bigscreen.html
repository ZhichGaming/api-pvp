<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>API PVP – Arena</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg:      #f4f5fb;
    --bg2:     #ffffff;
    --bg3:     #eef0f8;
    --border:  #d4d8ee;
    --accent:  #5b4fcf;
    --text:    #1e1e38;
    --dim:     #6b7080;
    --radius:  8px;
  }
  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    font-size: 14px;
    overflow: hidden;
  }
  body { display: flex; flex-direction: column; }
  #header {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 18px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }
  #mode-badge {
    padding: 3px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.78em;
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  .mode-test, .mode-sandbox, .mode-lobby { background: #e0f5ec; color: #1a7a4a; }
  .mode-battle   { background: #fde8e8; color: #9b2226; }
  .mode-finished { background: #fef9e7; color: #7a6200; }
  #tick-info { font-size: 0.8em; color: var(--dim); margin-left: auto; }
  #main { flex: 1; min-height: 0; display: flex; overflow: hidden; }
  #canvas-wrap {
    flex: 1;
    min-height: 0; min-width: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 12px;
    overflow: hidden;
    position: relative;
  }
  canvas {
    background: #eef0fc;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 2px 12px rgba(91,79,207,0.08);
    display: block;
    max-width: 100%;
    max-height: 100%;
  }
  #lobby-overlay {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    gap: 16px;
    padding: 32px;
  }
  #lobby-overlay h2 { color: var(--accent); font-size: 2em; letter-spacing: 3px; }
  #lobby-overlay .sub { color: var(--dim); font-size: 0.9em; }
  #lobby-player-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 8px; }
  .lobby-card {
    background: var(--bg3);
    border-radius: var(--radius);
    padding: 10px 20px;
    min-width: 140px;
    text-align: center;
    border-left: 4px solid #ccc;
  }
  .lobby-card .lname   { font-weight: bold; font-size: 1em; margin-bottom: 4px; }
  .lobby-card .lstatus { font-size: 0.75em; }
  .ready-yes { color: #1a7a4a; }
  .ready-no  { color: var(--dim); }
  #sidebar {
    width: 240px;
    flex-shrink: 0;
    background: var(--bg2);
    border-left: 1px solid var(--border);
    padding: 12px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  #sidebar h2 {
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--dim);
    border-bottom: 1px solid var(--border);
    padding-bottom: 6px;
  }
  .player-card {
    background: var(--bg3);
    border-radius: 6px;
    padding: 8px 10px;
    border-left: 3px solid #ccc;
  }
  .player-card.dead { opacity: 0.5; }
  .pcard-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
  .player-name  { font-weight: 600; font-size: 0.88em; }
  .kick-btn {
    padding: 1px 7px;
    background: transparent;
    color: #bbb;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.75em;
    cursor: pointer;
    line-height: 1.4;
    transition: color 0.1s, border-color 0.1s;
  }
  .kick-btn:hover { color: #e74c3c; border-color: #e74c3c; }
  .kick-btn.kick-confirm { color: #e74c3c; border-color: #e74c3c; background: #fde8e8; font-size: 0.68em; }
  .player-stat  { font-size: 0.72em; color: var(--dim); display: flex; justify-content: space-between; margin-bottom: 2px; }
  .hp-bar       { height: 5px; background: #e0e4f0; border-radius: 3px; margin-top: 3px; overflow: hidden; }
  .hp-bar-fill  { height: 100%; border-radius: 3px; transition: width 0.15s; }
  #controls { margin-top: auto; border-top: 1px solid var(--border); padding-top: 10px; display: flex; flex-direction: column; gap: 6px; }
  #controls button {
    padding: 8px;
    background: var(--bg3);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.82em;
    transition: background 0.1s;
  }
  #controls button:hover { background: #e0e4f0; }
  #controls button.primary { background: #e8e6fc; color: var(--accent); border-color: #c5c0f0; font-weight: 600; }
  #controls button.primary:hover { background: #d8d4f8; }
  #winner-banner {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 40px 60px;
    border-radius: 16px;
    border: 2px solid var(--accent);
    box-shadow: 0 8px 40px rgba(91,79,207,0.2);
    text-align: center;
    z-index: 100;
  }
  #winner-banner h2 { color: var(--accent); font-size: 2em; margin-bottom: 10px; }
  #winner-banner p  { color: var(--dim); font-size: 1.1em; }
  #winner-banner button {
    margin-top: 16px; padding: 8px 24px;
    background: var(--bg3); color: var(--text);
    border: 1px solid var(--border); border-radius: 6px; cursor: pointer;
  }
</style>
</head>
<body>

<div id="header">
  <span id="mode-badge" class="mode-lobby">LOBBY</span>
  <span id="tick-info">Tick: 0</span>
</div>

<div id="main">
  <div id="canvas-wrap">
    <canvas id="arena" style="display:none"></canvas>
    <div id="lobby-overlay">
      <h2>API PVP</h2>
      <div class="sub">Waiting for battle to start&hellip;</div>
      <div id="lobby-player-list"></div>
      <div class="sub" id="lobby-ready-status" style="margin-top:4px"></div>
    </div>
  </div>

  <div id="sidebar">
    <h2>Players</h2>
    <div id="player-list"></div>
    <div id="controls">
      <button class="primary" onclick="startBattle()">&#9654; Start Battle</button>
      <button onclick="resetGame()">&#8635; Reset to Sandbox</button>
    </div>
  </div>
</div>

<div id="winner-banner">
  <h2>&#127942; <span id="winner-name"></span></h2>
  <p id="winner-stats"></p>
  <button onclick="this.parentElement.style.display='none'">Close</button>
</div>

<script>
var arenaCanvas = document.getElementById('arena');
var ctx = arenaCanvas.getContext('2d');
var CELL = 24;

var P = {
  bg:          '#eef0fc',
  grid:        'rgba(0,0,60,0.05)',
  arenaBorder: '#5b4fcf',
  wallFill:    '#c0c5e8',
  wallStroke:  '#9098c8',
  crateFill:   '#d4a870',
  crateStroke: '#b08840',
  bulletFill:  '#e67e22',
  bulletGlow:  'rgba(230,126,34,0.5)',
  deadStroke:  '#ccc',
  shieldRing:  'rgba(80,100,255,0.45)',
  playerBorder:'rgba(0,0,0,0.12)',
  playerName:  '#111',
  hpBarBg:     '#dde1f0'
};

var state = null;

var renderPositions = {}; // player id → {x, y} interpolated display coords
var lastRafTime = 0;
var lastTickTime = 0;
var BULLET_SPEED_PER_SEC = 100; // matches server: 5 units/tick × 20 ticks/s

function lerp(a, b, t) { return a + (b - a) * t; }

function resizeArenaCanvas() {
  if (!state || !state.arena) return;
  var wrap = document.getElementById('canvas-wrap');
  var a = state.arena;
  var maxW = wrap.clientWidth  - 24;
  var maxH = wrap.clientHeight - 24;
  var scale = Math.min(maxW / (a.width * CELL), maxH / (a.height * CELL), 1.6);
  arenaCanvas.width  = Math.floor(a.width  * CELL * scale);
  arenaCanvas.height = Math.floor(a.height * CELL * scale);
  arenaCanvas._scale = scale;
}

window.addEventListener('resize', resizeArenaCanvas);

var wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
var ws;

function connectWS() {
  ws = new WebSocket(wsProtocol + '//' + location.host + '?type=bigscreen');
  ws.onmessage = function(e) {
    var msg = JSON.parse(e.data);
    if (msg.type === 'state') {
      // Initialise render positions for players appearing for the first time
      (msg.data.players || []).forEach(function(p) {
        if (!renderPositions[p.id]) renderPositions[p.id] = { x: p.x, y: p.y };
      });
      state = msg.data;
      lastTickTime = performance.now();
      tick();
    }
  };
  ws.onclose = function() { setTimeout(connectWS, 1000); };
  ws.onerror = function() { ws.close(); };
}
connectWS();

// 60 fps render loop — interpolates player positions and extrapolates bullets
requestAnimationFrame(function rafLoop(ts) {
  requestAnimationFrame(rafLoop);
  if (!state || !state.arena || state.mode === 'lobby') { lastRafTime = ts; return; }
  var dt = lastRafTime > 0 ? Math.min(0.1, (ts - lastRafTime) / 1000) : 0;
  lastRafTime = ts;
  var lerpT = Math.min(1, dt * 25); // factor 25 → ~87% of remaining distance covered per server tick
  (state.players || []).forEach(function(p) {
    var rp = renderPositions[p.id];
    if (rp) { rp.x = lerp(rp.x, p.x, lerpT); rp.y = lerp(rp.y, p.y, lerpT); }
  });
  render(ts);
});

function tick() {
  updateHeader();
  if (!state.arena || state.mode === 'lobby') {
    showLobby();
  } else {
    showArena();
    // render() is driven by the requestAnimationFrame loop below
  }
  updateSidebar();
}

function showLobby() {
  arenaCanvas.style.display = 'none';
  document.getElementById('lobby-overlay').style.display = 'flex';
  var players = state.players || [];
  var list = document.getElementById('lobby-player-list');
  list.innerHTML = players.map(function(p) {
    return '<div class="lobby-card" style="border-left-color:' + (p.color || '#5b4fcf') + '">' +
      '<div class="lname" style="color:' + (p.color || '#5b4fcf') + '">' + esc(p.username) + '</div>' +
      '<div class="lstatus ' + (p.ready ? 'ready-yes' : 'ready-no') + '">' + (p.ready ? '&#10003; Ready' : '&#9675; Not ready') + '</div>' +
      '</div>';
  }).join('') || '<div style="color:#aaa;font-size:0.9em">No players yet</div>';
  var readyCount = players.filter(function(p) { return p.ready; }).length;
  document.getElementById('lobby-ready-status').textContent =
    players.length ? (readyCount + ' / ' + players.length + ' ready') : '';
}

function showArena() {
  document.getElementById('lobby-overlay').style.display = 'none';
  arenaCanvas.style.display = 'block';
  if (!arenaCanvas._scale) resizeArenaCanvas();
}

function render(ts) {
  if (!state || !state.arena) return;
  ts = (ts != null) ? ts : performance.now();
  var s = arenaCanvas._scale || 1;
  var a = state.arena;

  ctx.clearRect(0, 0, arenaCanvas.width, arenaCanvas.height);
  ctx.fillStyle = P.bg;
  ctx.fillRect(0, 0, arenaCanvas.width, arenaCanvas.height);

  ctx.strokeStyle = P.grid;
  ctx.lineWidth = 0.5;
  for (var x = 0; x <= a.width; x++) {
    ctx.beginPath(); ctx.moveTo(x*CELL*s,0); ctx.lineTo(x*CELL*s,a.height*CELL*s); ctx.stroke();
  }
  for (var y = 0; y <= a.height; y++) {
    ctx.beginPath(); ctx.moveTo(0,y*CELL*s); ctx.lineTo(a.width*CELL*s,y*CELL*s); ctx.stroke();
  }

  ctx.strokeStyle = P.arenaBorder;
  ctx.lineWidth = 2;
  ctx.strokeRect(0, 0, a.width*CELL*s, a.height*CELL*s);

  var obs;
  for (var i = 0; i < (a.obstacles||[]).length; i++) {
    obs = a.obstacles[i];
    ctx.fillStyle   = obs.type === 'wall' ? P.wallFill  : P.crateFill;
    ctx.strokeStyle = obs.type === 'wall' ? P.wallStroke : P.crateStroke;
    ctx.lineWidth = 1;
    ctx.fillRect  (obs.x*CELL*s, obs.y*CELL*s, obs.w*CELL*s, obs.h*CELL*s);
    ctx.strokeRect(obs.x*CELL*s, obs.y*CELL*s, obs.w*CELL*s, obs.h*CELL*s);
  }

  var proj, px, py;
  var dtProj = Math.min(0.05, (ts - lastTickTime) / 1000); // cap at one tick (50ms) to avoid over-shooting during lag
  for (var i = 0; i < (state.projectiles||[]).length; i++) {
    proj = state.projectiles[i];
    px = (proj.x + proj.dx * BULLET_SPEED_PER_SEC * dtProj)*CELL*s;
    py = (proj.y + proj.dy * BULLET_SPEED_PER_SEC * dtProj)*CELL*s;
    ctx.fillStyle = P.bulletFill;
    ctx.shadowColor = P.bulletGlow;
    ctx.shadowBlur = 8*s;
    ctx.beginPath(); ctx.arc(px, py, 3.5*s, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.strokeStyle = P.bulletGlow;
    ctx.lineWidth = 2*s;
    ctx.beginPath();
    ctx.moveTo(px, py);
    ctx.lineTo(px - proj.dx*CELL*s*0.5, py - proj.dy*CELL*s*0.5);
    ctx.stroke();
  }

  var p, r, bW, bH, bX, bY, hpP, rp;
  for (var i = 0; i < (state.players||[]).length; i++) {
    p = state.players[i];
    rp = renderPositions[p.id] || p;
    px = rp.x*CELL*s; py = rp.y*CELL*s;
    r = 0.4*CELL*s;

    if (!p.alive) {
      ctx.strokeStyle = P.deadStroke;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(px-r*0.6,py-r*0.6); ctx.lineTo(px+r*0.6,py+r*0.6);
      ctx.moveTo(px+r*0.6,py-r*0.6); ctx.lineTo(px-r*0.6,py+r*0.6);
      ctx.stroke();
      continue;
    }

    if (p.shielded) {
      ctx.strokeStyle = P.shieldRing;
      ctx.lineWidth = 3*s;
      ctx.beginPath(); ctx.arc(px, py, r+5*s, 0, Math.PI*2); ctx.stroke();
    }

    ctx.fillStyle = p.color || '#5b4fcf';    ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = P.playerBorder;
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(px, py, r, 0, Math.PI*2); ctx.stroke();

    ctx.fillStyle = P.playerName;
    ctx.font = '600 ' + Math.max(9, Math.round(11*s)) + 'px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(p.username, px, py - r - 6*s);

    bW = r*2.4; bH = 4*s;
    bX = px - bW/2; bY = py + r + 5*s;
    ctx.fillStyle = P.hpBarBg;
    ctx.fillRect(bX, bY, bW, bH);
    hpP = (p.hp||0)/100;
    ctx.fillStyle = hpP>0.5 ? '#2ecc71' : hpP>0.25 ? '#f39c12' : '#e74c3c';
    ctx.fillRect(bX, bY, bW*hpP, bH);
  }

  if (state.mode === 'finished' && state.winner) {
    document.getElementById('winner-name').textContent  = state.winner.username + ' Wins!';
    document.getElementById('winner-stats').textContent = 'HP: ' + state.winner.hp + '  |  Kills: ' + state.winner.kills;
    document.getElementById('winner-banner').style.display = 'block';
  }
}

function updateHeader() {
  var badge = document.getElementById('mode-badge');
  badge.textContent = state.mode.toUpperCase();
  badge.className   = 'mode-' + state.mode;
  document.getElementById('tick-info').textContent = 'Tick: ' + (state.tick || 0);
}

function updateSidebar() {
  var players = (state.players || []).slice().sort(function(a,b){ return (b.hp||0)-(a.hp||0); });
  document.getElementById('player-list').innerHTML = players.map(function(p) {
    var hp = p.hp != null ? p.hp : 100;
    var hpColor = hp>50 ? '#2ecc71' : hp>25 ? '#f39c12' : '#e74c3c';
    return '<div class="player-card ' + (p.alive===false?'dead':'') + '" style="border-left-color:' + (p.color||'#ccc') + '">' +
      '<div class="pcard-header">' +
        '<div class="player-name" style="color:' + (p.color||'#333') + '">' + esc(p.username) + '</div>' +
        '<button class="kick-btn' + (p.id === pendingKickId ? ' kick-confirm' : '') + '" onclick="kickPlayer(\'' + p.id + '\')">' + (p.id === pendingKickId ? '&#10003;?' : '&#10005;') + '</button>' +
      '</div>' +
      '<div class="player-stat"><span>HP</span><span>' + hp + '/100</span></div>' +
      '<div class="hp-bar"><div class="hp-bar-fill" style="width:' + hp + '%;background:' + hpColor + '"></div></div>' +
      '<div class="player-stat"><span>Ammo</span><span>' + (p.ammo!=null?p.ammo:'&mdash;') + '</span></div>' +
      '<div class="player-stat"><span>Kills</span><span>' + (p.kills||0) + '</span></div>' +
      (p.alive===false?'<div style="color:#e74c3c;font-size:0.72em;margin-top:3px">&#9760; Eliminated</div>':'') +
      '</div>';
  }).join('');
}

function startBattle() {
  fetch('/start', { method: 'POST', headers: {'Content-Type':'application/json'} });
}

function resetGame() {
  document.getElementById('winner-banner').style.display = 'none';
  arenaCanvas._scale = null;
  fetch('/reset', { method: 'POST', headers: {'Content-Type':'application/json'} });
}

var pendingKickId = null;
var pendingKickTimer = null;
function kickPlayer(id) {
  if (pendingKickId === id) {
    clearTimeout(pendingKickTimer);
    pendingKickId = null;
    pendingKickTimer = null;
    fetch('/player/' + id, { method: 'DELETE' });
  } else {
    if (pendingKickTimer) clearTimeout(pendingKickTimer);
    pendingKickId = id;
    pendingKickTimer = setTimeout(function() { pendingKickId = null; pendingKickTimer = null; }, 2000); // 2s to confirm
    if (state) updateSidebar();
  }
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>